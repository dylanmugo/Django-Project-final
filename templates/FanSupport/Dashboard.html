{% extends 'FanSupport/base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Dashboard</h1>

  <!-- Chart Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <strong>Ticket Status Overview</strong>
    </div>
    <div class="card-body">
      <canvas id="statusChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Role-Based Dashboards -->
  <div class="card my-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">Role-Specific Dashboards</h5>
    </div>
    <div class="card-body">
      <div class="row row-cols-1 row-cols-md-2 g-3">
        {% for group in user.groups.all %}
          {% if group.name == 'SupportAgent' %}
            <div class="col">
              <a href="{% url 'support_agent_dashboard' %}" class="btn btn-outline-primary w-100">Support Agent Dashboard</a>
            </div>
          {% elif group.name == 'EscalationManager' %}
            <div class="col">
              <a href="{% url 'escalation_dashboard' %}" class="btn btn-outline-danger w-100">Escalation Manager Dashboard</a>
            </div>
          {% elif group.name == 'SupportSupervisor' %}
            <div class="col">
              <a href="{% url 'supervisor_dashboard' %}" class="btn btn-outline-success w-100">Support Supervisor Dashboard</a>
            </div>
          {% elif group.name == 'BillingSpecialist' %}
            <div class="col">
              <a href="{% url 'billing_dashboard' %}" class="btn btn-outline-warning w-100">Billing Dashboard</a>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Tickets Table Section -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <strong>Your Tickets</strong>
    </div>
    <div class="card-body">
      {% if user_tickets %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
              <th>Subject</th>
              <th>Category</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Created On</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in user_tickets %}
            <tr>
              <td>{{ ticket.subject }}</td>
              <td>{{ ticket.get_category_display }}</td>
              <td>{{ ticket.priority }}</td>
              <td>{{ ticket.status }}</td>
              <td>{{ ticket.created_at|date:"M d, Y" }}</td>
              <td>
                <a href="{% url 'ticket_detail' ticket.id %}" class="btn btn-sm btn-outline-primary">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No tickets found.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Include Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const statusLabels = {{ status_labels|safe }};
  const statusData = {{ status_data|safe }};

  const ctx = document.getElementById('statusChart').getContext('2d');
  const statusChart = new Chart(ctx, {
      type: 'pie',
      data: {
          labels: statusLabels,
          datasets: [{
              label: 'Ticket Status',
              data: statusData,
              backgroundColor: [
                  'rgba(255, 99, 132, 0.7)',
                  'rgba(54, 162, 235, 0.7)',
                  'rgba(255, 206, 86, 0.7)',
              ],
              borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
              ],
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { position: 'bottom' },
              title: {
                  display: true,
                  text: 'Tickets by Status'
              }
          }
      }
  });
</script>
{% endblock %}
